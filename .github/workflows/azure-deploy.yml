name: Build and Deploy to Azure Web App (Container)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    # (Removed secret validation step â€” using secrets directly in the deploy step below.)

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: '9.0.x'

    - name: Restore
      run: dotnet restore backend/ObituaryApp

    - name: Build
      run: dotnet build backend/ObituaryApp -c Release --no-restore

    - name: Publish
      run: dotnet publish backend/ObituaryApp -c Release -o ./publish

    - name: Zip publish output
      run: |
        apt-get update && apt-get install -y zip || true
        zip -r publish.zip ./publish

    - name: Debug publish profile and package
      env:
        PUBLISH_PROFILE: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        WEBAPP_NAME: ${{ secrets.AZURE_WEBAPP_NAME }}
      run: |
        echo "WEBAPP_NAME (from secret): '${WEBAPP_NAME}'"
        echo -n "PUBLISH_PROFILE size (bytes): "; printf "%s" "$PUBLISH_PROFILE" | wc -c
        echo "Publish.zip exists? "; if [ -f publish.zip ]; then echo "yes"; ls -lh publish.zip; else echo "no"; fi
        echo "Publish preview (first 200 chars):"; printf "%s" "$PUBLISH_PROFILE" | head -c 200 || true

    - name: Try Kudu ZipDeploy (direct)
      id: kudu-deploy
      env:
        PUBLISH_PROFILE: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        WEBAPP_NAME: ${{ secrets.AZURE_WEBAPP_NAME }}
      run: |
        set -e
        echo "$PUBLISH_PROFILE" > publish_profile.xml
        # Extract ZipDeploy credentials from publish profile
        USER=$(grep -oP 'publishMethod="ZipDeploy"[^>]*userName="\K[^"]+' publish_profile.xml || true)
        PWD=$(grep -oP 'publishMethod="ZipDeploy"[^>]*userPWD="\K[^"]+' publish_profile.xml || true)
        if [ -z "$USER" ] || [ -z "$PWD" ]; then
          echo "Could not extract ZipDeploy credentials from publish profile."
          exit 2
        fi
        echo "Deploying publish.zip to https://$WEBAPP_NAME.scm.azurewebsites.net/api/zipdeploy"
        # Use multipart form upload
        HTTP_CODE=$(curl -s -o /tmp/kudu_response.txt -w "%{http_code}" -u "$USER:$PWD" -F package=@publish.zip "https://$WEBAPP_NAME.scm.azurewebsites.net/api/zipdeploy")
        echo "Kudu response HTTP code: $HTTP_CODE"
        cat /tmp/kudu_response.txt || true
        if [ "$HTTP_CODE" -ge 400 ]; then
          echo "Kudu ZipDeploy failed with HTTP $HTTP_CODE"
          exit 3
        fi

    - name: Deploy to Azure Web App using Publish Profile (fallback)
      if: ${{ steps.kudu-deploy.outcome != 'success' }}
      uses: azure/webapps-deploy@v2
      with:
        app-name: ${{ secrets.AZURE_WEBAPP_NAME }}
        publish-profile: ${{ secrets.AZURE_WEBAPP_PUBLISH_PROFILE }}
        package: ./publish.zip

    - name: Completed
      run: echo "Deployment step finished. Configure secrets AZURE_WEBAPP_NAME and AZURE_WEBAPP_PUBLISH_PROFILE in repository settings."
